<!doctype html>
<html>
	<head>
		<link href="//fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
		<script src="https://aframe.io/releases/0.8.0/aframe.min.js"></script>
		<script src="https://jeromeetienne.github.io/AR.js/aframe/build/aframe-ar.js"></script>
		<style>
			body,
			html {
				font-family: 'Roboto', sans-serif;
				font-size: 16px;
				margin: 0;
				overflow: hidden;
				padding: 0;
			}

			#counter,
			#debug {
				background: rgba(0,0,0,0.7);
				color: #fff;
				margin: 5px 0 0 0;
				padding: 5px 10px;
			}


			#overlay {
				align-items: center;
				display: flex;
				flex-direction: column;
				left: 0;
				position: absolute;
				top: 0;
				width: 100%;
			}
		</style>
	</head>
	<script>
		const markers=[];

		function Marker(elem){
			this.elem=elem;
			this.name=elem.querySelector('a-text').getAttribute('value');
			this.visible=false;
			this.lastScreenPos=null;
			this.records={
				in: 0,
				out: 0
			};

			this.setVisible=visible=>{
				if(this.visible!==visible){
					this.visible=visible;
					if(this.visible){
						// Visible
					}else{
						// Not visible
					}
				}
			}
		}

		function getScreenPos(marker){
			const vector=marker.elem.object3D.position.clone();

			vector.project(scene.camera);
			return {
				x: vector.x,
				y: vector.y
			};
		};

		AFRAME.registerComponent('markerhandler', {
			init: _=>{
				this.tick=AFRAME.utils.throttleTick(this.tick, 500, this);
			},
			tick: (t, dt)=>{
				for(let marker of markers){
					marker.setVisible(marker.elem.object3D.visible);
					if(marker.visible){
						marker.lastScreenPos=getScreenPos(marker);
					}else if(marker.lastScreenPos!==null){
						if(marker.lastScreenPos.x<0){ // Last seen on the left side of the camera
							marker.records.out++;
						}else{ // Last seen on the right side of the camera
							marker.records.in++;
						}
						marker.lastScreenPos=null;
					}
				}
				debug.innerHTML=markers.map(marker=>{
					return `${marker.name}: ${marker.records.in} in${marker.records.in!==1?'s':''}, ${marker.records.out} out${marker.records.out!==1?'s':''}`;
				}).join('<br>');
			}
		});
	</script>
	<body>
		<a-scene embedded arjs='sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3;'>
			<a-marker markerhandler type='barcode' id='m0' value='0'>
				<a-text rotation='-90 0 0' side='double' value='ALICE' color='red' align='center' geometry='primitive:plane' material='color:red;wireframe:true'></a-text>
			</a-marker>
			<a-marker markerhandler type='barcode' id='m1' value='1'>
				<a-text rotation='-90 0 0' side='double' value='BOB' color='red' align='center' geometry='primitive:plane' material='color:red;wireframe:true'></a-text>
			</a-marker>
			<a-entity camera></a-entity>
		</a-scene>
		<div id="overlay">
			<div id="debug"></div>
		</div>
	</body>
	<script>
		const scene=document.querySelector('a-scene');
		const counter=document.getElementById('counter');
		const debug=document.getElementById('debug');

		for(let marker of document.querySelectorAll('a-marker')){
			markers.push(new Marker(marker));
		}
	</script>
</html>