<!doctype html>
<html>
	<head>
		<link href="//fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
		<script src="https://aframe.io/releases/0.8.0/aframe.min.js"></script>
		<script src="https://jeromeetienne.github.io/AR.js/aframe/build/aframe-ar.js"></script>
		<style>
			body,
			html {
				font-family: 'Roboto', sans-serif;
				font-size: 16px;
				margin: 0;
				overflow: hidden;
				padding: 0;
			}

			#direction,
			#debug {
				background: rgba(0,0,0,0.7);
				color: #fff;
				margin: 5px 0 0 0;
				padding: 5px 10px;
			}


			#overlay {
				align-items: center;
				display: flex;
				flex-direction: column;
				left: 0;
				position: absolute;
				top: 0;
				width: 100%;
			}
		</style>
	</head>
	<script>
		const NUM_MARKERS=10;
		const markers=[];

		let pass='';

		function Marker(elem){
			this.elem=elem;
			this.name=elem.querySelector('a-text').getAttribute('value');
			this.visible=false;
			this.lastScreenPos=null;
			this.records={
				in: 0,
				out: 0
			};

			this.setVisible=visible=>{
				if(this.visible!==visible){
					this.visible=visible;
					if(this.visible){
						// Visible
					}else{
						// Not visible
					}
				}
			}
		}

		function getScreenPos(marker){
			const vector=marker.elem.object3D.position.clone();

			vector.project(scene.camera);
			return {
				x: vector.x,
				y: vector.y
			};
		};

		pass=prompt('Please enter the password:');
		fetch(`https://script.google.com/macros/s/AKfycbxLAjo14BEZjM1I5Yw4OCRqLIFjQsm7248QcNN7u8ULKvuL2ljm/exec?func=checkPass&pass=${pass}`).then(res=>{
			return res.json();
		}).then(data=>{
			if(!data.success){
				pass='';
				alert('Sorry but the password is incorrect. Records will not be saved.');
			}
		});

		AFRAME.registerComponent('markerhandler', {
			init: _=>{
				this.tick=AFRAME.utils.throttleTick(this.tick, 500, this);
			},
			tick: (t, dt)=>{
				for(let marker of markers){
					marker.setVisible(marker.elem.object3D.visible);
					if(marker.visible){
						marker.lastScreenPos=getScreenPos(marker);
					}else if(marker.lastScreenPos!==null){
						if(marker.lastScreenPos.x<0){ // Last seen on the left side of the camera
							marker.records.out++;
							fetch(`https://script.google.com/macros/s/AKfycbxLAjo14BEZjM1I5Yw4OCRqLIFjQsm7248QcNN7u8ULKvuL2ljm/exec?func=addRecord&id=${marker.name}&time=${new Date().getTime()}&in_out=0&pass=${pass}`);
						}else{ // Last seen on the right side of the camera
							marker.records.in++;
							fetch(`https://script.google.com/macros/s/AKfycbxLAjo14BEZjM1I5Yw4OCRqLIFjQsm7248QcNN7u8ULKvuL2ljm/exec?func=addRecord&id=${marker.name}&time=${new Date().getTime()}&in_out=1&pass=${pass}`);
						}
						marker.lastScreenPos=null;
					}
				}
				debug.innerHTML=markers.map(marker=>{
					return `${marker.name}: ${marker.records.in} in${marker.records.in!==1?'s':''}, ${marker.records.out} out${marker.records.out!==1?'s':''}`;
				}).join('<br>');
			}
		});
	</script>
	<body>
		<a-scene embedded arjs='sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3;'>
			<a-marker markerhandler type='barcode' id='m0' value='0'>
				<a-text rotation='-90 0 0' side='double' value='0' color='red' align='center' geometry='primitive:plane' material='color:red;wireframe:true'></a-text>
			</a-marker>
			<a-entity camera></a-entity>
		</a-scene>
		<div id="overlay">
			<div id="direction">OUT -> IN</div>
			<div id="debug"/div>
		</div>
	</body>
	<script>
		const scene=document.querySelector('a-scene');
		const genesis=document.querySelector('a-marker');
		const camera=document.querySelector('a-entity');
		const counter=document.getElementById('counter');
		const direction=document.getElementById('direction');
		const debug=document.getElementById('debug');

		for(let i=1; i<NUM_MARKERS; i++){
			const newMarker=genesis.cloneNode(true);

			newMarker.setAttribute('id', `m${i}`);
			newMarker.setAttribute('value', i);
			newMarker.firstElementChild.setAttribute('value', i);
			scene.insertBefore(newMarker, camera);
		}
		for(let marker of document.querySelectorAll('a-marker')){
			markers.push(new Marker(marker));
		}
	</script>
</html>